/*!
 * Manifest v1.3.6
 *
 * A jQuery plugin that adds delight to selecting multiple values for an input.
 *
 * https://github.com/jstayton/jquery-manifest
 *
 * Copyright 2013 by Justin Stayton
 * Licensed MIT
 */
(function(e){"use strict";typeof define=="function"&&define.amd?define(["jquery"],e):e(jQuery)})(function(e,t){"use strict";e.widget("mf.manifest",{options:{formatDisplay:function(e,t,n){return n?n.html():e},formatRemove:function(){return"X"},formatValue:function(e,t,n,r){return r?r.text():e},marcoPolo:!1,onAdd:null,onChange:null,onHighlight:null,onHighlightRemove:null,onRemove:null,onSelect:null,onSelectRemove:null,required:!1,separator:",",values:null,valuesName:null},_marcoPoloOptions:function(){var e=this,t=e.options;return{onFocus:function(){t.marcoPolo.onFocus&&t.marcoPolo.onFocus.call(this),e._resizeInput()},onRequestAfter:function(){e.$container.parent().removeClass("mf_busy"),t.marcoPolo.onRequestAfter&&t.marcoPolo.onRequestAfter.call(this)},onRequestBefore:function(){e.$container.parent().addClass("mf_busy"),t.marcoPolo.onRequestBefore&&t.marcoPolo.onRequestBefore.call(this)},onSelect:function(n,r){var i=!0;t.marcoPolo.onSelect&&(i=t.marcoPolo.onSelect.call(this,n,r)),i!==!1&&e.add(n,r,!0,!1)},required:t.required}},keys:{BACKSPACE:8,DELETE:46,DOWN:40,END:35,ENTER:13,HOME:36,LEFT:37,RIGHT:39,UP:38},_create:function(){var t=this,n=t.options,r,i;t.$input=i=t.element.addClass("mf_input"),t.inputName="mf_"+(i.attr("name")||e.now()),t.$container=e('<div class="mf_container" />'),t.$list=e('<ol class="mf_list" />').attr({"aria-atomic":"false","aria-live":"polite","aria-multiselectable":"true",id:t.inputName+"_list",role:"listbox"}),t.$measure=e('<span class="mf_measure" />'),t.mousedown=!1,t.mpMousedown=!1,t.inputOriginals={"aria-owns":i.attr("aria-owns"),role:i.attr("role"),width:i.css("width")},n.marcoPolo?(r=i.val(),i.val(""),t._bindMarcoPolo(),i.attr("aria-owns",i.attr("aria-owns")+" "+t.$list.attr("id")),i.val(r)):i.attr({"aria-owns":t.$list.attr("id"),role:"combobox"}),t._bindInput()._bindList()._bindContainer()._bindDocument(),i.wrap(t.$container).before(t.$list).after(t.$measure),t.$container=i.parent(),n.values&&t.add(n.values,null,!1,!0),t._addInputValues()._styleMeasure()._resizeInput()},_setOption:function(t,n){var r=this,i=r.$input;switch(t){case"marcoPolo":r.options.marcoPolo?n?i.marcoPolo("option",e.extend({},n,r._marcoPoloOptions())):i.marcoPolo("destroy"):n&&(r._bindMarcoPolo(e.extend({},n,r._marcoPoloOptions())),i.marcoPolo("list").insertAfter(i.parent()));break;case"required":r.options.marcoPolo&&i.marcoPolo("option","required",n);break;case"values":r.add(n,null,!1,!1);break;case"valuesName":r.$list.find("input:hidden.mf_value").attr("name",n+"[]")}e.Widget.prototype._setOption.apply(r,arguments)},_bindMarcoPolo:function(n){var r=this,i=r.$input,s=r.options;return n===t&&(n=e.extend({},s.marcoPolo,r._marcoPoloOptions())),i.marcoPolo(n),i.marcoPolo("list").bind("mousedown.manifest",function(){r.mpMousedown=!0}),r},_bindInput:function(){var t=this,n=t.$input,r=t.options,i=r.marcoPolo&&r.marcoPolo.minChars===0,s=[t.keys.UP,t.keys.DOWN,t.keys.HOME,t.keys.END];return n.bind("keydown.manifest",function(o){t._resizeInput();if(!r.required&&t._isSeparator(o.which)){o.preventDefault(),n.val()&&t.add(n.val(),null,!0,!1);return}if(o.which===t.keys.ENTER){o.preventDefault();return}if(n.val())return;if(i&&e.inArray(o.which,s)!==-1)return;switch(o.which){case t.keys.BACKSPACE:case t.keys.DELETE:var u=t._selected();u.length?t.remove(u):t._selectPrev();break;case t.keys.LEFT:case t.keys.UP:t._selectPrev();break;case t.keys.RIGHT:case t.keys.DOWN:t._selectNext();break;case t.keys.HOME:t._selectFirst();break;case t.keys.END:t._selectLast();break;default:t._removeSelected()}}).bind("keypress.manifest",function(e){!r.required&&t._isSeparator(String.fromCharCode(e.which))&&(e.preventDefault(),n.val()&&t.add(n.val(),null,!0,!1))}).bind("keyup.manifest",function(){t._resizeInput()}).bind("paste.manifest",function(){setTimeout(function(){t._resizeInput(),!r.required&&n.val()&&t.add(t._splitBySeparator(n.val()),null,!0,!1)},1)}).bind("blur.manifest",function(){setTimeout(function(){t.mousedown||t._removeSelected(),t.mpMousedown||(r.marcoPolo&&r.required?t._resizeInput():n.val()&&t.add(n.val(),null,!0,!1))},1)}),t},_bindList:function(){var t=this;return t.$list.delegate("li","mouseover",function(){t._addHighlight(e(this))}).delegate("li","mouseout",function(){t._removeHighlight(e(this))}).delegate("li","mousedown",function(){t.mousedown=!0}).delegate("li","click",function(n){e(n.target).is("a.mf_remove")?(t._removeSelected(),t.remove(e(this)),n.preventDefault()):t._toggleSelect(e(this))}),t},_bindContainer:function(){var e=this;return e.$container.bind("click.manifest",function(){e.$input.focus()}),e},_bindDocument:function(){var t=this,n=t.$input;return e(document).bind("mouseup.manifest",function(r){t.mousedown&&(t.mousedown=!1,e(r.target).is("li.mf_item, li.mf_item *")||t._removeSelected()),t.mpMousedown&&(t.mpMousedown=!1,t.options.required?t._resizeInput():n.val()&&t.add(n.val(),null,!0,!1))}),t},container:function(){return this.$container},list:function(){return this.$list},add:function(t,n,r,i){var s=this,o=s.$input,u=s.options,a=e.isArray(t)?t:[t],f,l=e(),c=e(),h=e(),p=function(t,n,r){l.html(t),c.html(n),h.val(r),l.append(c,h),e.when(s._trigger("add",[f,l,!!i])).then(function(e){e!==!1&&(l.appendTo(s.$list),i||s._trigger("change",["add",f,l]))})};for(var d=0,v=a.length;d<v;d++){f=a[d],typeof f=="string"&&(f=e.trim(f));if(!f||e.isPlainObject(f)&&e.isEmptyObject(f))continue;l=e('<li class="mf_item" role="option" aria-selected="false" />'),c=e('<a href="#" class="mf_remove" title="Remove" />'),h=e('<input type="hidden" class="mf_value" />'),u.valuesName?h.attr("name",u.valuesName+"[]"):h.attr("name",o.attr("name")+"_values[]"),l.data("manifest",f),e.when(u.formatDisplay.call(o,f,l,n),u.formatRemove.call(o,c,l),u.formatValue.call(o,f,h,l,n)).then(p)}r&&s._clearInputValue()},_addInputValues:function(){var t=this,n=t.$input,r=n.data("values"),i=n.val(),s=[];return r?s=e.isArray(r)?r:[r]:i&&(s=t._splitBySeparator(i)),s.length&&t.add(s,null,!0,!0),t},remove:function(t){var n=this,r=e();t instanceof jQuery?r=t:r=n.$list.children(t),r.each(function(){var t=e(this),r=t.data("manifest");e.when(n._trigger("remove",[r,t])).then(function(e){e!==!1&&(n._isSelected(t)&&n._removeSelect(t),t.remove(),n._trigger("change",["remove",r,t]))})})},values:function(){var t=this,n=t.$list,r=[];return n.find("input:hidden.mf_value").each(function(){r.push(e(this).val())}),r},destroy:function(){var n=this,r=n.$input;n.options.marcoPolo&&r.marcoPolo("destroy"),n.$list.remove(),n.$measure.remove(),r.unwrap().removeClass("mf_input").val(n._joinWithSeparator(n.values())),e.each(n.inputOriginals,function(e,n){n===t?r.removeAttr(e):r.attr(e,n)}),e(document).unbind(".manifest"),e.Widget.prototype.destroy.apply(n,arguments)},_styleMeasure:function(){var e=this,t=e.$input;return e.$measure.css({"font-family":t.css("font-family"),"font-size":t.css("font-size"),"font-style":t.css("font-style"),"font-variant":t.css("font-variant"),"font-weight":t.css("font-weight"),left:-9999,"letter-spacing":t.css("letter-spacing"),position:"absolute","text-transform":t.css("text-transform"),top:-9999,"white-space":"nowrap",width:"auto","word-spacing":t.css("word-spacing")}),e},_measureText:function(e){var t=this.$measure,n;return n=e.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),t.html(n),t.width()},_maxInputWidth:function(){var e=this,t=e.$container,n=e.$input;return t.width()-(n.outerWidth(!0)-n.width())},_resizeInput:function(){var e=this,t=e.$input,n;return n=e._measureText(t.val()+"---"),t.width(Math.min(n,e._maxInputWidth())),e},_clearInputValue:function(){var e=this,t=e.$input;return e.options.marcoPolo?t.marcoPolo("change",null):t.val(""),e._resizeInput(),e},_isSeparator:function(t){var n=this.options.separator;return e.isArray(n)?e.inArray(t,n)!==-1:t===n},_separators:function(t){var n=this.options.separator,r=e.isArray(n)?n:[n];return t&&(r=e.grep(r,function(e){return typeof e=="string"})),r},_firstSeparator:function(e){return this._separators(e).shift()},_splitBySeparator:function(t){var n=this._separators(!0),r=t;return n.length&&(r=t.split(new RegExp("[\\"+n.join("\\")+"]")),r=e.map(r,e.trim)),r},_joinWithSeparator:function(e){var t=this._firstSeparator(!0)||"";return e.join(t+" ")},_firstItem:function(){return this.$list.children("li:first")},_lastItem:function(){return this.$list.children("li:last")},_highlighted:function(){return this.$list.children("li.mf_highlighted")},_addHighlight:function(e){var t=this;return e.length?(t._removeHighlighted(),e.addClass("mf_highlighted"),t._trigger("highlight",[e.data("marcoPolo"),e]),t):t},_removeHighlight:function(e){var t=this;return e.length?(e.removeClass("mf_highlighted"),t._trigger("highlightRemove",[e.data("marcoPolo"),e]),t):t},_removeHighlighted:function(){return this._removeHighlight(this._highlighted())},_selected:function(){return this.$list.children("li.mf_selected")},_isSelected:function(e){return e.hasClass("mf_selected")},_addSelect:function(e){var t=this;return e.length?(t._removeSelected(),e.addClass("mf_selected").attr({"aria-selected":"true",id:t.inputName+"_selected"}),t.$list.attr("aria-activedescendant",e.attr("id")),t._trigger("select",[e.data("marcoPolo"),e]),t):t},_removeSelect:function(e){var t=this;return e.length?(e.removeClass("mf_selected").attr("aria-selected","false").removeAttr("id"),t.$list.removeAttr("aria-activedescendant"),t._trigger("selectRemove",[e.data("marcoPolo"),e]),t):t},_removeSelected:function(){return this._removeSelect(this._selected())},_toggleSelect:function(e){return this._isSelected(e)?this._removeSelect(e):this._addSelect(e)},_selectPrev:function(){var t=this,n=t._selected(),r=e();return n.length?r=n.prev():r=t._lastItem(),r.length&&t._addSelect(r),t},_selectNext:function(){var e=this,t=e._selected(),n=t.next();return n.length?e._addSelect(n):e._removeSelect(t)},_selectFirst:function(){return this._addSelect(this._firstItem())},_selectLast:function(){return this._addSelect(this._lastItem())},_trigger:function(e,t){var n=this,r="on"+e.charAt(0).toUpperCase()+e.slice(1),i=n.widgetEventPrefix.toLowerCase()+e.toLowerCase(),s=n.options[r];return n.element.trigger(i,t),s&&s.apply(n.element,t)}})});